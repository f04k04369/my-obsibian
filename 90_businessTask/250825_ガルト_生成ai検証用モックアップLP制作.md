---
created: 2025-08-25
tags:
  - BottoK
  - web制作
  - 検証
  - 調査
aliases:
  - ガルト
  - 生成AI
  - web制作
reration: 250822_ガルト_生成ai画像仕様変更検証
---
# AI検証用 家具テストデータ – 要件定義・設計・運用まとめ
https://ai-generated-image-survey-lp.vercel.app/
最終更新: 2025-08-26（Asia/Tokyo）

---

## 1. プロジェクト概要

- **目的**: 家具 20 点の画像・仕様を一元化し、**画像生成AIの再現性検証**（寸法変更などの指示で“より現実に近い画像”が生成されるか）を行うための**参照サイト**を構築する。
    
- **要点**
    
    - 各プロダクトの**ヒーロー画像**と**仕様画像**を Google Drive から参照。
        
    - サイト上で**仕様の閲覧**（画像/PDFプレビュー）と**画像のダウンロード**が可能。
        
    - **フォルダZIP**で商品一式、または**ルートZIP**で全体一括取得が可能。
        
    - **スクレイピングは採用しない**。データ管理は Google Drive＋`products.json` に一本化。
        
    - **Vercel** で静的ホスティング＋サーバレス関数(API)を利用。
        

---

## 2. ユースケース / 成果物

- **閲覧者**がカード一覧から家具を探す → 詳細（仕様）をモーダル表示 → ヒーロー画像DL or フォルダZIPで一括DL。
    
- **検証担当者**が `products.json` を差し替えるだけでラインナップを更新。
    
- **配布**や**社外共有**に耐える、リンク1つで使える軽量なLP。
    

---

## 3. 非機能要件

- **デプロイ容易性**: Git に push → Vercel 自動デプロイ。
    
- **可用性**: 画像は Drive 側の稼働と共有設定に依存。サイト側は静的ページで高可用。
    
- **パフォーマンス**: 画像は Drive 直リンクまたはサーバレスプロキシで配信。Lazy Load とフォールバックあり。
    
- **セキュリティ**: Drive 公開可否に応じて運用を切替（直リンク or プロキシ）。APIは**読み取り専用**のサービスアカウントを使用。
    

---

## 4. データソース（Google Drive）

- ルートフォルダ: **AI-Image-Test-Furniture**  
    `rootFolderId`: `13xyzirIEkKUPTRY74QNP6kkOFrc3HMUh`
    
- 各商品フォルダ配下に
    
    - `hero_*.*`（ヒーロー画像）
        
    - `spec_*.*`（仕様画像/図面/PDF など複数可）
        
    - `readme.txt` は**不使用**
        
- 共有設定（運用ポリシーに応じて選択）
    
    - **公開で配布**: 「リンクを知っている全員：閲覧者」→ ブラウザ直DLが可能
        
    - **非公開運用**: サービスアカウントの**閲覧者共有**のみ → 個別直DL不可のため**APIプロキシ**経由を使用
        

---

## 5. ディレクトリ構成（最終）

> **vercel.json は使用しない構成**（安定運用）

`/ ├─ index.html          # フロントエンド（Tailwind＋素JS） ├─ products.json       # GAS出力を統合した最終データ（DriveのID・メタ情報） ├─ package.json        # API依存（googleapis, archiver） └─ api/    ├─ folder-zip.js    # 指定フォルダを再帰的にZIP化して返す    └─ file-proxy.js    #（任意）DriveファイルをSA経由でストリーム配信`

---

## 6. ホスティング（Vercel）

- **Framework Preset**: **Other (No Framework)**
    
- **Build Command / Output Directory**: 空欄
    
- **Environment Variables**
    
    - `GOOGLE_SERVICE_ACCOUNT_EMAIL`: サービスアカウントの `client_email`
        
    - `GOOGLE_PRIVATE_KEY`: サービスアカウントの `private_key`（複数行のままでOK。`\n` も可）
        
- **Drive 共有**: ルートフォルダ（および配下）をサービスアカウントに**閲覧者**で共有
    

> 備考: `vercel.json` を使う場合は v2 形式に限るが、本プロジェクトでは **置かない**方針。  
> v1（Now）誤解釈による「`now-php@1.0.0`～」エラーを回避。

---

## 7. `products.json` スキーマ

`{   "rootFolderId": "string", // ルートDriveフォルダID（全体ZIP用）   "items": [     {       "slug": "string",      // 一意な識別子（表示には未使用・内部管理）       "title": "string",     // 表示名（例: "IKEA - MALM（4段）"）       "brand": "string",     // "IKEA" | "ニトリ" 等       "category": "string",  // "チェスト" "デスク" 等       "url": "string|null",  // メーカー公式URL（任意）       "dimensions": {        // 寸法（任意キー: W, D, H, Base など）         "W": 80,         "D": 48,         "H": 100       },       "seatHeight": 42|null, // 座面高（該当すれば）       "materials": ["string", ...] | null,       "folderId": "string",  // 商品フォルダID（ZIP/Driveで開くリンクで使用）       "heroFileId": "string|null",     // ヒーロー画像のDrive fileId       "specFileId": "string|null",     // 既定の仕様ファイルID（単数）       "specFileIds": ["string", ...]   // 仕様ファイルIDの配列（複数対応）     }   ] }`

- **必須**: `rootFolderId`, `items[].folderId`, `items[].heroFileId`（画像表示に使用）
    
- **任意**: `dimensions`, `seatHeight`, `materials`, `url`, `specFileIds`
    

---

## 8. UI/機能仕様（`index.html`）

### 8.1 カード一覧

- **情報**: 画像・タイトル・ブランド/カテゴリ・寸法/座面高/素材・公式URL
    
- **ボタン**
    
    - **画像DL**: `https://drive.google.com/uc?export=download&id=<heroFileId>`
        
    - **仕様を見る**: 仕様画像/PDFの**モーダル**表示（複数対応・左右ナビ）
        
    - **フォルダZIP**: `/api/folder-zip?folderId=<folderId>`
        
    - **Driveで開く**: `https://drive.google.com/drive/folders/<folderId>`
        

### 8.2 画像のフェイルオーバー（サムネイル非表示対策）

1. **通常**: `uc?export=view&id=<heroFileId>`
    
2. **失敗時**: `thumbnail?id=<id>&sz=w1200`（JPEG/PNGサムネイル）
    
3. **さらに失敗**: `/api/file-proxy?id=<id>`（サービスアカウント経由）
    
4. **最終**: プレースホルダ画像
    

> Drive 側が**制限付き**や **AVIF** 等の場合の表示崩れを吸収。

### 8.3 仕様モーダル

- `specFileIds` をスライド切替
    
- 画像として読み込み失敗→ `https://drive.google.com/file/d/<id>/preview` でiframeプレビュー
    

### 8.4 フィルタ・検索

- **検索**: タイトル/ブランド/カテゴリ/URL/寸法/素材を全文検索
    
- **セレクト**: ブランド／カテゴリで絞り込み
    

---

## 9. API 仕様

### 9.1 `/api/folder-zip.js`

- **機能**: 指定 `folderId` 配下のファイル/サブフォルダを**再帰的にZIP**化してストリーム返却
    
- **クエリ**: `?folderId=<DriveFolderId>`
    
- **利用権限**: サービスアカウントが対象フォルダを**閲覧可能**であること
    
- **主な処理**
    
    - `drive.files.list` で子要素列挙 → フォルダは再帰
        
    - ファイルは `alt=media` でストリーム取得 → `archiver` に追加
        
- **応答**: `Content-Type: application/zip`  
    `Content-Disposition: attachment; filename="drive-<folderId>.zip"`
    

### 9.2 `/api/file-proxy.js`（任意・サムネ用フォールバック）

- **機能**: `fileId` を受け、サービスアカウントで `alt=media` をストリーム返却
    
- **クエリ**: `?id=<DriveFileId>`
    
- **用途**: 画像直リンクが権限/形式で失敗するケースの救済
    

> 両APIとも `GOOGLE_SERVICE_ACCOUNT_EMAIL` / `GOOGLE_PRIVATE_KEY` が必要。  
> 鍵は `\n` → 改行復元済み。

---

## 10. セットアップ手順（ローカル準備 → Drive → Vercel）

1. **サービスアカウント作成（GCP）**
    
    - Drive API を有効化 → サービスアカウントを作成 → **JSON鍵**を取得
        
    - `client_email` と `private_key` を控える
        
2. **Drive 共有**
    
    - ルート `AI-Image-Test-Furniture` をサービスアカウントに**閲覧者**で共有
        
    - 公開運用なら「リンクを知っている全員：閲覧者」にも
        
3. **Vercel プロジェクト作成**
    
    - リポジトリをインポート（Framework: **Other** / Build & Output: 空）
        
    - 環境変数に `GOOGLE_SERVICE_ACCOUNT_EMAIL` / `GOOGLE_PRIVATE_KEY` を登録
        
4. **配置**
    
    - ルート直下に `index.html` / `products.json`
        
    - `api/` に `folder-zip.js`（＋必要なら `file-proxy.js`）
        
    - `package.json` は依存に `googleapis` / `archiver`
        
5. **デプロイ → 動作確認**
    
    - `https://<app>.vercel.app/` が表示
        
    - Network で `./products.json` が 200
        
    - 画像サムネが表示（失敗ならサムネイル→プロキシに切替される）
        
    - ZIP API が動作
        

---

## 11. トラブルシューティング

### 11.1 ルートが 404

- Framework を **Other** にし、**vercel.json は置かない**
    
- `index.html` / `products.json` は**リポジトリ直下**に置く
    
- `index.html` の読み込みは `fetch('./products.json').catch(() => fetch('/products.json'))`
    

### 11.2 ビルドで「Function Runtimes must have a valid version, for example `now-php@1.0.0`」

- **v1 (Now) 誤解釈**が原因
    
- 対処:
    
    - `vercel.json` を**削除**
        
    - レガシー設定（`now.json`, `builds`, `use: now-*`, `package.json` の `now`）が残っていないか確認
        
    - 必要ならプロジェクトを新規で作り直す（再インポート）
        

### 11.3 画像が表示されない

- **権限**: Drive が制限付きの場合 → 公開にする or **`/api/file-proxy`** を有効活用
    
- **形式**: AVIF/HTMLプレビューなど → **`thumbnail?id=...&sz=w1200`** に自動フォールバック
    
- **最終**: プレースホルダ表示
    

### 11.4 ZIP がタイムアウト

- 無料枠では**時間制限**あり → **商品フォルダ単位**でZIP運用
    
- さらに大容量なら分割ZIPや一時ストレージ（R2/S3）案に拡張
    

---

## 12. 運用ガイド（権限と公開方針）

- **公開配布**: 個別DLリンク（uc?export=download）がそのまま使える → 手軽
    
- **非公開**: 個別DLは原則不可 → **画像表示は `/api/file-proxy` 経由**に切替する設計が望ましい  
    （`card()` で初期URLを `proxiedFileUrl(heroFileId)` にすれば強制プロキシ運用）
    

---

## 13. セキュリティ / プライバシー

- サービスアカウントは**閲覧専用**に限定。Drive側の共有は**最小権限**で付与。
    
- 公開したくない素材は**直リンクの公開設定を外す**。必要に応じて**プロキシのみ**許容。
    
- ダウンロードの監査や制限が必要なら、将来的に**署名付きURL**や**アクセスログ**を導入。
    

---

## 14. 将来の拡張（任意）

- **個別DLのAPI化**（`/api/file-download?id=...`）により完全非公開運用
    
- **キャッシュ層**の導入（画像/ZIPの再生成抑制）
    
- **Next.js化**（SSR/ISR、検索・並び替えの拡張、アクセシビリティ向上）
    
- **CSV/GAS→JSON 自動同期**（Webhookやスケジューラで `products.json` を更新）
    
- **メタデータの追加**（価格、カラー、モデル番号、タグ、バリエーション写真 等）
    

---

## 15. 受入基準（Acceptance Criteria）

-  トップページにカードが並び、**検索/フィルタ**が動作する
    
-  各カードの**画像**が表示（失敗時にサムネイル→プロキシ→プレースホルダ）
    
-  **仕様を見る**ボタンでモーダル表示（複数画像/PDF切替可）
    
-  **画像DL**ボタンが機能する（公開 or プロキシ）
    
-  **フォルダZIP**ボタンが動作し、ZIPがダウンロードできる
    
-  `products.json` を差し替えるだけで一覧が更新される
    
-  Vercel の **vercel.json 不要**構成でデプロイが安定
    

---

## 16. テスト項目

- **表示**: 主要ブラウザ（Chrome/Safari/Firefox/Edge）でヒーロー画像表示
    
- **フォールバック**: 一部画像の権限を制限して**フォールバック連鎖**を確認
    
- **ZIP**: 小規模フォルダ／大きめフォルダでZIP応答を確認（タイムアウト検証）
    
- **検索/フィルタ**: ブランド・カテゴリ・キーワードの組み合わせ
    
- **リンク**: 公式URL／Driveで開くの遷移・セキュリティ確認
    

---

## 17. 変更履歴（要約）

- 初期の**静的LP**（外部サイト直リンク）から開始
    
- **スクレイピング案**は採用見送り → **Drive＋JSON**に統一
    
- **Vercel v1誤解釈**エラーにより、`vercel.json` **非使用**へ方針転換
    
- 画像**サムネイル非表示**問題に対応：**3段階フォールバック**＋**プロキシAPI**を追加
    
- セットアップ・運用手順を**簡素化**（Framework: Other / Build/Output 空 / 直下配置）
    

---

## 18. 付録：サンプル `products.json` の 1 アイテム例

`{   "rootFolderId": "13xyzirIEkKUPTRY74QNP6kkOFrc3HMUh",   "items": [     {       "slug": "14-ikea-malm-chest-20354646",       "title": "IKEA - MALM（4段）",       "brand": "IKEA",       "category": "チェスト",       "url": "https://www.ikea.com/jp/ja/p/malm-chest-of-4-drawers-white-20354646/",       "dimensions": { "W": 80, "D": 48, "H": 100 },       "seatHeight": null,       "materials": ["パーティクルボード", "アクリル塗装"],       "folderId": "134EmS-andhST9P34aIJbkaRCdnVZatKw",       "heroFileId": "1q4xozyTx8Bx9d4s8hCvrYEu5kculC5iK",       "specFileId": "1ji1v_0LKUb1-23rrYOPOR-pQJ7smOEQo",       "specFileIds": ["1ji1v_0LKUb1-23rrYOPOR-pQJ7smOEQo"]     }   ] }`

---